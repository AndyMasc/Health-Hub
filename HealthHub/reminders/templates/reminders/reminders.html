{% extends 'base.html' %}

{% block head %}
    {% load static %}
    <link rel="stylesheet" href="{% static 'reminders/css/reminders_style.css' %}">
{% endblock %}

{% block content %}
    <div class="heading">
        <div style="align-self:center;">
            <h1> {{ request.user.username }}'s reminders
                <button id="info-button" class="info-button" style="cursor:pointer;">
                    <svg style="width:30px; transform:translateY(3px); margin:0;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" />
                    </svg>
                </button>
            </h1>
            <dialog id="info-dialog">
                    <h2> Reminders </h2>
                    <h3> - Reminders can be managed by doctor and patients. Changes from either party are global. </h3>
                    <h3> - Reminders are ordered by priority. </h3>
                    <h3> - Edit a reminder by selecting the text, editing as desired, and clicking refresh. </h3>
                <button id="closeInfo" class="closeDialog"> Continue </button>
            </dialog>
        </div>

        <div class="page-links">
            <a href="{% url 'workspace:dashboard' %}" class="return-home">
                <svg style="width:25px; transform:translateY(6px); margin-right:10px;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
                </svg>
                Return home
            </a>
            <a href="{% url 'reminders:add_reminder' %}" class="add-reminder"> + Add a reminder </a>
        </div>
    </div>

    <div class="reminder-stats">
        <div class="completed-stats" style="background-color:#e9f9e9;">
            <h1> {{ completed_reminders|length }} </h1>
            <h3> Completed </h3>
        </div>
        <div class="completed-stats" style="background-color:#e9f3f9;">
            <h1> {{ reminders|length }} </h1>
            <h3> Pending </h3>
        </div>
        <div class="completed-stats" style="background-color:#fef5f5">
            <h1> {{ high_priority_reminders|length }} </h1>
            <h3> High priority </h3>
        </div>
    </div>

    <div class="widget-container">
        {% if reminders %}
            {% for reminder in reminders %}
                {% if reminder in high_priority_reminders %}
                    <div class="reminder-widget" style="background:#fef5f5;">
                {% else %}
                    <div class="reminder-widget">
                {% endif %}
                    <div class="widget-content">
                        <form action="{% url 'reminders:update_reminder' reminder.id %}" method="POST" id="update-form">
                            {% csrf_token %}
                            <input placeholder="Reminder title" required maxlength="70" name="title" class="reminder-title" style="margin-bottom:8px;" value="{{ reminder.title }}"></input>
                            <p style="color:grey; font-weight:200; margin-top:10px; margin-bottom:0;">
                                <svg style="color:grey; width:20px; transform:translateY(3px); margin-right:10px;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                                </svg>
                                <span class="created-by"> <b> Set by {{ reminder.created_by.username }} ({{ reminder.created_by.account.role }}) · {{ reminder.date_added|timesince }} ago </b> </span>
                            </p>
                            <p style="color:grey; margin-top:0;">
                                <svg style="color:grey; width:20px; transform:translateY(3px); margin-right:10px;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5m-9-6h.008v.008H12v-.008ZM12 15h.008v.008H12V15Zm0 2.25h.008v.008H12v-.008ZM9.75 15h.008v.008H9.75V15Zm0 2.25h.008v.008H9.75v-.008ZM7.5 15h.008v.008H7.5V15Zm0 2.25h.008v.008H7.5v-.008Zm6.75-4.5h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V15Zm0 2.25h.008v.008h-.008v-.008Zm2.25-4.5h.008v.008H16.5v-.008Zm0 2.25h.008v.008H16.5V15Z" />
                                </svg>
                                {% if reminder not in high_priority_reminders %}
                                    Due in {{ reminder.due_date|timeuntil }}
                                {% else %}
                                    Due {{ reminder.due_date|timesince }} ago
                                {% endif %}
                                ·<input type="date" id="due_date" name="due_date" placeholder="Due date" class="due_date" value="{{ reminder.due_date|date:'Y-m-d' }}">
                            </p>
                            <textarea style="margin-top:8px; margin-bottom:16px;" placeholder="Reminder content" required maxlength="3000" name="content">{{ reminder.content }}</textarea>
                        </form>

                        <div class="reminder-actions">
                            <button class="update" id="update">
                                <svg style="width:25px; transform:translateY(3px);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                                </svg>
                            </button>
                            <a href="{% url 'reminders:delete_reminder' reminder.id %} ">
                                <svg style="width:25px; color:black; transform:translateY(3px);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                                </svg>
                            </a>
                        </div>

                        <div class="complete-links">
                            {% if reminder in high_priority_reminders %}
                                <span class="status" style="border:solid #ba2b32E6; background:transparent; color:#ba2b32E6"> High priority </span>
                            {% else %}
                                <span class="status" style="border:solid #0066ccE6; background:transparent; color:#0066ccE6"> Low priority </span>
                            {% endif %}

                            <a href="{% url 'reminders:complete_reminder' reminder.id %}" class="complete">
                                Complete
                            </a>
                        </div>

                        <dialog id="update-success">
                            <h2> Refresh reminder? </h2>
                            <h3> The selected reminder will be refreshed with the new content. </h3>
                            <button id="closeDialog" class="closeDialog">Continue</button>
                        </dialog>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="reminder-widget">
                <h1 style="position:absolute; font-weight:500; font-size:1.6rem; place-self:center;"> You have no reminders. </h1>
            </div>
        {% endif %}
        </div>
    </div>

    <script>
            document.addEventListener('click', (e) => {
                const updateBtn = e.target.closest('.update');
                if (updateBtn) {
                    const widget = updateBtn.closest('.reminder-widget');
                    const dialog = widget.querySelector('dialog');
                    dialog.showModal();
                    return; // prevent running closeDialog check
                }

                const closeBtn = e.target.closest('.closeDialog');
                if (closeBtn) {
                    const widget = closeBtn.closest('.reminder-widget');
                    const form = widget.querySelector('form');
                    const dialog = widget.querySelector('dialog');

                    form.submit();
                    dialog.close();
                }
            });
            const infoButton = document.getElementById('info-button');
            const infoDialog = document.getElementById('info-dialog');
            const closeInfo = document.getElementById('closeInfo');
            infoButton.addEventListener('click', () => {
                infoDialog.showModal();
            })
            closeInfo.addEventListener('click', () => {
                infoDialog.close();
            })
        </script>
{% endblock %}